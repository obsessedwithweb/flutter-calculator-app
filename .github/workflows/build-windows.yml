name: Build and Release Flutter Windows App

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 'stable'
          channel: 'stable'
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build Windows app
        run: flutter build windows --release
      
      # Get app version from pubspec.yaml
      - name: Get version
        id: version
        run: |
          $version = Select-String -Path pubspec.yaml -Pattern "version: (.+)" | ForEach-Object { $_.Matches.Groups[1].Value }
          echo "APP_VERSION=$version" >> $env:GITHUB_OUTPUT
      
      # Create ZIP archive
      - name: Create ZIP archive
        run: |
          $appName = (Select-String -Path pubspec.yaml -Pattern "name: (.+)" | ForEach-Object { $_.Matches.Groups[1].Value }).Trim()
          Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath "$appName-${{ steps.version.outputs.APP_VERSION }}-windows.zip"
      
      # Install WiX Toolset for MSI creation
      - name: Install WiX Toolset
        run: |
          choco install wixtoolset -y
          echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      
      # Create MSI installer
      - name: Create MSI installer
        run: |
          $appName = (Select-String -Path pubspec.yaml -Pattern "name: (.+)" | ForEach-Object { $_.Matches.Groups[1].Value }).Trim()
          $version = "${{ steps.version.outputs.APP_VERSION }}"
          $buildDir = "build\windows\x64\runner\Release"
          
          # Create WiX source file
          @"
          <?xml version="1.0" encoding="UTF-8"?>
          <Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
            <Product Id="*" Name="$appName" Language="1033" Version="$version" Manufacturer="YourCompany" UpgradeCode="YOUR-GUID-HERE">
              <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />
              <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
              <MediaTemplate EmbedCab="yes" />
              
              <Feature Id="ProductFeature" Title="$appName" Level="1">
                <ComponentGroupRef Id="ProductComponents" />
              </Feature>
              
              <Directory Id="TARGETDIR" Name="SourceDir">
                <Directory Id="ProgramFilesFolder">
                  <Directory Id="INSTALLFOLDER" Name="$appName" />
                </Directory>
                <Directory Id="ProgramMenuFolder">
                  <Directory Id="ApplicationProgramsFolder" Name="$appName"/>
                </Directory>
              </Directory>
              
              <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
                <Component Id="MainExecutable" Guid="*">
                  <File Id="AppExe" Source="$buildDir\$appName.exe" KeyPath="yes">
                    <Shortcut Id="StartMenuShortcut" Directory="ApplicationProgramsFolder" Name="$appName" WorkingDirectory="INSTALLFOLDER" Icon="AppIcon.exe" IconIndex="0" Advertise="yes" />
                  </File>
                </Component>
                <Component Id="DataFolder" Guid="*">
                  <File Id="DataLib" Source="$buildDir\flutter_windows.dll" KeyPath="yes" />
                </Component>
              </ComponentGroup>
              
              <Icon Id="AppIcon.exe" SourceFile="$buildDir\$appName.exe" />
            </Product>
          </Wix>
          "@ | Out-File -FilePath installer.wxs -Encoding UTF8
          
          # Compile and link
          candle.exe installer.wxs
          light.exe -ext WixUIExtension installer.wixobj -out "$appName-$version-windows.msi"
      
      # Create/Update Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            *.zip
            *.msi
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}