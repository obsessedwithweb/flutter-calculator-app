
import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';

void main() {
  runApp(const CalculatorApp());
}

class CalculatorApp extends StatelessWidget {
  const CalculatorApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Glassmorphism Calculator',
      theme: ThemeData.dark(),
      home: const CalculatorScreen(),
    );
  }
}

class CalculatorScreen extends StatefulWidget {
  const CalculatorScreen({super.key});

  @override
  _CalculatorScreenState createState() => _CalculatorScreenState();
}

class _CalculatorScreenState extends State<CalculatorScreen> {
  String _display = '0';
  String _history = '';
  double? _firstOperand;
  String? _operation;
  bool _shouldClearDisplay = true;
  double _memory = 0;

  final FocusNode _focusNode = FocusNode();

  @override
  void initState() {
    super.initState();
    _focusNode.requestFocus();
  }

  @override
  void dispose() {
    _focusNode.dispose();
    super.dispose();
  }

  void _handleKeyEvent(RawKeyEvent event) {
    if (event is RawKeyDownEvent) {
      final key = event.logicalKey;
      String keyLabel = key.keyLabel;

      if ('0123456789.'.contains(keyLabel)) {
        _onButtonPressed(keyLabel);
      } else if (key == LogicalKeyboardKey.enter || keyLabel == '=') {
        _onButtonPressed('=');
      } else if (key == LogicalKeyboardKey.backspace) {
        _onButtonPressed('⌫');
      } else if (keyLabel == '+') {
        _onButtonPressed('+');
      } else if (keyLabel == '-') {
        _onButtonPressed('-');
      } else if (keyLabel == '*') {
        _onButtonPressed('×');
      } else if (keyLabel == '/') {
        _onButtonPressed('÷');
      } else if (keyLabel.toLowerCase() == 'c') {
        _onButtonPressed('C');
      }
    }
  }

  void _onButtonPressed(String buttonText) {
    setState(() {
      if ('0123456789.'.contains(buttonText)) {
        _handleDigitInput(buttonText);
      } else if ('+-×÷'.contains(buttonText)) {
        _handleOperatorInput(buttonText);
      } else if (buttonText == '=') {
        _handleEquals();
      } else if (buttonText == 'C') {
        _handleClear();
      } else if (buttonText == '⌫') {
        _handleBackspace();
      } else if (buttonText == 'M') {
        _display = _formatResult(_memory);
        _shouldClearDisplay = true;
      } else if (buttonText == 'M+') {
        _memory += double.tryParse(_display) ?? 0;
      } else if (buttonText == 'M-') {
        _memory -= double.tryParse(_display) ?? 0;
      }
    });
  }

  void _handleDigitInput(String digit) {
    if (_shouldClearDisplay) {
      _display = (digit == '.') ? '0.' : digit;
      _shouldClearDisplay = false;
    } else {
      if (digit == '.' && _display.contains('.')) return;
      _display += digit;
    }
  }

  void _handleOperatorInput(String op) {
    if (_firstOperand == null) {
      _firstOperand = double.tryParse(_display);
    } else if (!_shouldClearDisplay) {
      _calculate();
    }
    _operation = op;
    _history = '${_formatResult(_firstOperand!)} $_operation';
    _shouldClearDisplay = true;
  }

  void _handleEquals() {
    if (_firstOperand == null || _operation == null) return;
    _calculate();
    _history = '';
    _operation = null;
    _shouldClearDisplay = true;
  }

  void _calculate() {
    if (_shouldClearDisplay) return; // Avoid re-calculating with the same second operand
    double secondOperand = double.tryParse(_display) ?? 0;
    double result = 0;

    switch (_operation) {
      case '+':
        result = _firstOperand! + secondOperand;
        break;
      case '-':
        result = _firstOperand! - secondOperand;
        break;
      case '×':
        result = _firstOperand! * secondOperand;
        break;
      case '÷':
        result = secondOperand != 0 ? _firstOperand! / secondOperand : double.nan;
        break;
    }

    _display = result.isNaN ? 'Error' : _formatResult(result);
    _firstOperand = result.isNaN ? 0 : result;
  }

  void _handleClear() {
    _display = '0';
    _history = '';
    _firstOperand = null;
    _operation = null;
    _shouldClearDisplay = true;
  }

  void _handleBackspace() {
    if (_shouldClearDisplay) return;
    _display = _display.length > 1 ? _display.substring(0, _display.length - 1) : '0';
    if (_display == '0') _shouldClearDisplay = true;
  }

  String _formatResult(double value) {
    if (value.isNaN) return 'Error';
    if (value == value.toInt()) {
      return value.toInt().toString();
    } else {
      return value.toString();
    }
  }

  Widget _buildButtonRow(List<String> buttons) {
    return Expanded(
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.stretch,
        children: buttons.map((text) {
          return Expanded(
            child: CalculatorButton(
              text: text,
              onPressed: () => _onButtonPressed(text),
              isOperator: '+-×÷='.contains(text),
              isAction: 'C⌫'.contains(text),
              isMemory: 'M M+ M-'.contains(text),
            ),
          );
        }).toList(),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black,
      body: RawKeyboardListener(
        focusNode: _focusNode,
        onKey: _handleKeyEvent,
        child: Column(
          children: [
            Expanded(
              flex: 2,
              child: Container(
                padding: const EdgeInsets.fromLTRB(20, 0, 20, 20),
                alignment: Alignment.bottomRight,
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.end,
                  crossAxisAlignment: CrossAxisAlignment.end,
                  children: [
                    FittedBox(
                      fit: BoxFit.contain,
                      child: Text(
                        _history,
                        style: const TextStyle(fontSize: 24, color: Colors.white54),
                        maxLines: 1,
                      ),
                    ),
                    const SizedBox(height: 8),
                    FittedBox(
                      fit: BoxFit.contain,
                      child: Text(
                        _display,
                        style: const TextStyle(fontSize: 64, color: Colors.white),
                        maxLines: 1,
                      ),
                    ),
                  ],
                ),
              ),
            ),
            Expanded(
              flex: 3,
              child: Column(
                children: [
                  _buildButtonRow(['C', '⌫', 'M', '÷']),
                  _buildButtonRow(['7', '8', '9', '×']),
                  _buildButtonRow(['4', '5', '6', '-']),
                  _buildButtonRow(['1', '2', '3', '+']),
                  _buildButtonRow(['M+', '0', 'M-', '=']),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class CalculatorButton extends StatelessWidget {
  final String text;
  final VoidCallback onPressed;
  final bool isOperator;
  final bool isAction;
  final bool isMemory;

  const CalculatorButton({
    super.key,
    required this.text,
    required this.onPressed,
    this.isOperator = false,
    this.isAction = false,
    this.isMemory = false,
  });

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.all(8.0),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(24),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 5, sigmaY: 5),
          child: Container(
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [
                  Colors.white.withOpacity(0.1),
                  Colors.white.withOpacity(0.2),
                ],
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
              ),
              border: Border.all(
                color: Colors.white.withOpacity(0.2),
              ),
              borderRadius: BorderRadius.circular(24),
            ),
            child: Material(
              color: Colors.transparent,
              child: InkWell(
                onTap: onPressed,
                borderRadius: BorderRadius.circular(24),
                child: Center(
                  child: FittedBox(
                    fit: BoxFit.contain,
                    child: Text(
                      text,
                      style: TextStyle(
                        fontSize: 28,
                        fontWeight: FontWeight.w500,
                        color: isOperator
                        ? Colors.orange
                        : isAction
                        ? Colors.redAccent
                        : isMemory
                        ? Colors.green
                        : Colors.white,
                      ),
                    ),
                  ),
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }
}
